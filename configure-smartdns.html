<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    SmartDNS 配置 - 永久记录
    
    </title>
    

    
    
    <link href="atom.xml" rel="alternate" title="永久记录" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/style.min.css">
    <link rel="stylesheet" href="asset/css/doc.css">
    <script src="asset/app.js"></script>
</head>
  <body>
    <section class="hero">
      <div class="hero-head">
          <nav class="navbar" role="navigation" aria-label="main navigation">
              <div class="container">
              <div class="navbar-brand">
                
                <a target="_self" class="navbar-item " href="index.html">Home</a>
                
                <a target="_self" class="navbar-item " href="archives.html">Archives</a>
                
                <a target="_self" class="navbar-item " href="about.html">About</a>
                

                <a role="button" id="navbarSNSRssSwitchBtn" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarSNSRssButtons">
                  <span aria-hidden="true"></span>
                  <span aria-hidden="true"></span>
                  <span aria-hidden="true"></span>
                </a>
              </div>
            
              <div id="navbarSNSRssButtons" class="navbar-menu">
                <div class="navbar-start">
                  
                </div>
            
                <div class="navbar-end">
                  <div class="navbar-item">
                    <!--buttons start-->
                    <div class="buttons">
                      
                        
                        
                        
                        
                      
                      <a href="atom.xml" target="_blank" title="RSS">
                          <span class="icon is-large has-text-black-bis">
                              <svg class="svg-inline--fa fa-rss fa-w-14 fa-lg" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                          </span>
                      </a>
                    </div>
                    <!--buttons end-->

                  </div>
                </div>
                </div>
              </div>
            </nav>
      </div>

 <div class="hero-body ct-body"></div>
      
    </section>
    <section class="ct-body">
      <div class="container">
          <div class="columns is-variable bd-klmn-columns is-4 is-centered">
              <div class="column is-four-fifths">
                  <div class="post-body single-content">
                    
                    <h1 class="title">
                            SmartDNS 配置   
                      </h1>
                     
                    
                      <div class="media">
                            
                            <div class="media-content">
                              <div class="content">
                                <p>
                                 <span class="date">2024/05/11</span>
                                  
                                         
                                  

                                   
                                      
                                  <br />
                                  <span class="tran-tags">Tags:</span>&nbsp;
                                  
                                    <a class="tag is-link is-light" href='tag_DNS%E5%88%86%E6%B5%81.html'>#DNS分流</a>
                                  
                                    <a class="tag is-link is-light" href='tag_DNS-over-HTTPS.html'>#DNS-over-HTTPS</a>
                                  
                                    <a class="tag is-link is-light" href='tag_macOS.html'>#macOS</a>
                                     

                                </p>
                              </div>
                            </div>
                         
                    </div>
                </div>
                  <article class="markdown-body single-content">
                    <div class="mweb_toc"><ul>
<li><a href="#smartdns%E5%AE%89%E8%A3%85">SmartDNS 安装</a>
<ul>
<li><a href="#%E5%9B%BD%E5%86%85%E7%BD%91%E7%AB%99%E5%88%86%E6%B5%81">国内网站分流</a></li>
<li><a href="#%E8%B0%83%E6%95%B4smartdns%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">调整 SmartDNS 配置文件</a></li>
<li><a href="#smartdns%E7%AE%A1%E7%90%86">SmartDNS 管理</a></li>
</ul>
</li>
<li><a href="#smartdns%E5%B1%8F%E8%94%BD%E5%B9%BF%E5%91%8A%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89">SmartDNS 屏蔽广告（可选）</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
</div>
<p>在<a href="configure-DNS-over-HTTPS-for-macOS.html">macOS 配置 DNS-over-HTTPS</a>一文中，使用mosdns作为转发工具，本文将用SmartDNS替换mosdns，其余配置不变。</p>
<p>优点：用户只需关注网站，无需关注IP地址。</p>
<h2><a id="smartdns%E5%AE%89%E8%A3%85" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>SmartDNS 安装</h2>
<p>使用homebrew安装，也可以到官网下载安装<a href="https://github.com/mokeyish/smartdns-rs">https://github.com/mokeyish/smartdns-rs</a>。SmartDNS仅作分流和转发，使用端口<code>5304</code>。</p>
<pre class="line-numbers"><code class="language-plain_text">$ brew install smartdns
</code></pre>
<p>默认安装的配置文件位置：<code>/opt/homebrew/etc/smartdns/smartdns.conf</code>。</p>
<h3><a id="%E5%9B%BD%E5%86%85%E7%BD%91%E7%AB%99%E5%88%86%E6%B5%81" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>国内网站分流</h3>
<p>同时下载国内网站列表<a href="https://github.com/felixonmars/dnsmasq-china-list">felixonmars/dnsmasq-china-list</a>，将整个仓库下载下来。</p>
<p>转化成SmartDNS规则：</p>
<pre class="line-numbers"><code class="language-plain_text">$ make SERVER=china smartdns-domain-rules
</code></pre>
<p>将自动生成三个文件：<code>accelerated-domains.china.domain.smartdns.conf</code>、<code>google.china.domain.smartdns.conf</code>以及<code>apple.china.domain.smartdns.conf</code>。</p>
<p>将上述三个文件移动至文件夹<code>/opt/homebrew/etc/smartdns/</code>。<br />
同时，在该文件夹下新建<code>self-defined.conf</code>，作为个人常用国内网站列表，格式参考其他文件。</p>
<h3><a id="%E8%B0%83%E6%95%B4smartdns%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>调整 SmartDNS 配置文件</h3>
<p>修改SmartDNS配置文件<code>/opt/homebrew/etc/smartdns/smartdns.conf</code>，大部分不用调整，仅限转发：</p>
<pre class="line-numbers"><code class="language-plain_text"># dns server name, default is host name
# server-name, 
# example:
#   server-name smartdns
#

# whether resolv local hostname to ip address
# resolv-hostname yes

# dns server run user
# user [username]
# example: run as nobody
#   user nobody
#

# Include another configuration options
# conf-file [file]
# conf-file blacklist-ip.conf

conf-file /opt/homebrew/etc/smartdns/self-defined.conf
conf-file /opt/homebrew/etc/smartdns/google.china.domain.smartdns.conf
conf-file /opt/homebrew/etc/smartdns/apple.china.domain.smartdns.conf
conf-file /opt/homebrew/etc/smartdns/accelerated-domains.china.domain.smartdns.conf

# dns server bind ip and port, default dns server port is 53, support binding multi ip and port
# bind udp server
#   bind [IP]:[port][@device] [-group [group]] [-no-rule-addr] [-no-rule-nameserver] [-no-rule-ipset] [-no-speed-check] [-no-cache] [-no-rule-soa] [-no-dualstack-selection]
# bind tcp server
#   bind-tcp [IP]:[port][@device] [-group [group]] [-no-rule-addr] [-no-rule-nameserver] [-no-rule-ipset] [-no-speed-check] [-no-cache] [-no-rule-soa] [-no-dualstack-selection]
# bind tls server
#   bind-tls [IP]:[port][@device] [-group [group]] [-no-rule-addr] [-no-rule-nameserver] [-no-rule-ipset] [-no-speed-check] [-no-cache] [-no-rule-soa] [-no-dualstack-selection]
#   bind-cert-key-file [path to file]
#      tls private key file
#   bind-cert-file [path to file]
#      tls cert file
#   bind-cert-key-pass [password]
#      tls private key password
# option:
#   -group: set domain request to use the appropriate server group.
#   -no-rule-addr: skip address rule.
#   -no-rule-nameserver: skip nameserver rule.
#   -no-rule-ipset: skip ipset rule or nftset rule.
#   -no-speed-check: do not check speed.
#   -no-cache: skip cache.
#   -no-rule-soa: Skip address SOA(#) rules.
#   -no-dualstack-selection: Disable dualstack ip selection.
#   -force-aaaa-soa: force AAAA query return SOA.
#   -set-mark: set mark on packets.
# example: 
#  IPV4: 
#    bind :53
#    bind :53@eth0
#    bind :6053 -group office -no-speed-check
#  IPV6:
#    bind [::]:53
#    bind [::]:53@eth0

bind-tcp :5304
bind :5304
bind-tcp [::]:5304
bind [::]:5304

# tcp connection idle timeout
# tcp-idle-time [second]
tcp-idle-time 300

# dns cache size
# cache-size [number]
#   0: for no cache
cache-size 0

# enable persist cache when restart
# cache-persist no

# cache persist file
# cache-file /tmp/smartdns.cache

# prefetch domain
# prefetch-domain [yes|no]
# prefetch-domain yes

# cache serve expired 
# serve-expired [yes|no]
# serve-expired yes

# cache serve expired TTL
# serve-expired-ttl [num]
# serve-expired-ttl 0

# reply TTL value to use when replying with expired data
# serve-expired-reply-ttl [num]
# serve-expired-reply-ttl 30

# List of hosts that supply bogus NX domain results 
# bogus-nxdomain [ip/subnet]

# List of IPs that will be filtered when nameserver is configured -blacklist-ip parameter
# blacklist-ip [ip/subnet]

# List of IPs that will be accepted when nameserver is configured -whitelist-ip parameter
# whitelist-ip [ip/subnet]

# List of IPs that will be ignored
# ignore-ip [ip/subnet]

# speed check mode
# speed-check-mode [ping|tcp:port|none|,]
# example:
#   speed-check-mode ping,tcp:80,tcp:443
#   speed-check-mode tcp:443,ping
speed-check-mode none

# force AAAA query return SOA
# force-AAAA-SOA [yes|no]

# force specific qtype return soa
# force-qtype-SOA [qtypeid |...]
# force-qtype-SOA 65 28
force-qtype-SOA 65

# Enable IPV4, IPV6 dual stack IP optimization selection strategy
# dualstack-ip-selection-threshold [num] (0~1000)
# dualstack-ip-allow-force-AAAA [yes|no]
# dualstack-ip-selection [yes|no]
# dualstack-ip-selection no

# edns client subnet
# edns-client-subnet [ip/subnet]
# edns-client-subnet 192.168.1.1/24
# edns-client-subnet 8::8/56

# ttl for all resource record
# rr-ttl: ttl for all record
# rr-ttl-min: minimum ttl for resource record
# rr-ttl-max: maximum ttl for resource record
# rr-ttl-reply-max: maximum reply ttl for resource record
# example:
rr-ttl 60
rr-ttl-min 0
rr-ttl-max 86400
# rr-ttl-reply-max 60

# Maximum number of IPs returned to the client|8|number of IPs, 1~16
# example:
# max-reply-ip-num 1

# response mode
# Experimental feature
# response-mode [first-ping|fastest-ip|fastest-response]

# set log level
# log-level: [level], level=fatal, error, warn, notice, info, debug
# log-file: file path of log file.
# log-console [yes|no]: output log to console.
# log-size: size of each log file, support k,m,g
# log-num: number of logs, 0 means disable log
log-level warn

log-file /opt/homebrew/etc/smartdns/smartdns.log
log-size 1024k
# log-num 2
# log-file-mode [mode]: file mode of log file.

# dns audit
# audit-enable [yes|no]: enable or disable audit.
# audit-enable yes
# audit-SOA [yes|no]: enable or disable log soa result.
# audit-size size of each audit file, support k,m,g
# audit-file /var/log/smartdns-audit.log
# audit-console [yes|no]: output audit log to console.
# audit-file-mode [mode]: file mode of audit file.
# audit-size 128k
# audit-num 2

# Support reading dnsmasq dhcp file to resolve local hostname
# dnsmasq-lease-file /var/lib/misc/dnsmasq.leases

# certificate file
# ca-file [file]
# ca-file /etc/ssl/certs/ca-certificates.crt

# certificate path
# ca-path [path]
# ca-path /etc/ss/certs

# remote udp dns server list
# server [IP]:[PORT]|URL [-blacklist-ip] [-whitelist-ip] [-check-edns] [-group [group] ...] [-exclude-default-group]
# default port is 53
#   -blacklist-ip: filter result with blacklist ip
#   -whitelist-ip: filter result with whitelist ip,  result in whitelist-ip will be accepted.
#   -check-edns: result must exist edns RR, or discard result.
#   -group [group]: set server to group, use with nameserver /domain/group.
#   -exclude-default-group: exclude this server from default group.
#   -proxy [proxy-name]: use proxy to connect to server.
#   -bootstrap-dns: set as bootstrap dns server.
# server 8.8.8.8 -blacklist-ip -check-edns -group g1 -group g2
# server tls://dns.google:853 
# server https://dns.google/dns-query

server 127.0.0.1:5300
server 127.0.0.1:5305 -group china -exclude-default-group

# remote tcp dns server list
# server-tcp [IP]:[PORT] [-blacklist-ip] [-whitelist-ip] [-group [group] ...] [-exclude-default-group]
# default port is 53
# server-tcp 8.8.8.8

server-tcp 127.0.0.1:5300
server-tcp 127.0.0.1:5305 -group china -exclude-default-group

# server-https https://223.5.5.5/dns-query -group china -exclude-default-group
# server-https https://doh.pub/dns-query -group china -exclude-default-group

# remote tls dns server list
# server-tls [IP]:[PORT] [-blacklist-ip] [-whitelist-ip] [-spki-pin [sha256-pin]] [-group [group] ...] [-exclude-default-group]
#   -spki-pin: TLS spki pin to verify.
#   -tls-host-verify: cert hostname to verify.
#   -host-name: TLS sni hostname.
#   -no-check-certificate: no check certificate.
#   -proxy [proxy-name]: use proxy to connect to server.
#   -bootstrap-dns: set as bootstrap dns server.
# Get SPKI with this command:
#    echo | openssl s_client -connect '[ip]:853' | openssl x509 -pubkey -noout | openssl pkey -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64
# default port is 853
# server-tls 8.8.8.8
# server-tls 1.0.0.1

# server-tls 223.5.5.5:853 -group china -exclude-default-group
# server-tls 223.6.6.6:853 -group china -exclude-default-group


# remote https dns server list
# server-https https://[host]:[port]/path [-blacklist-ip] [-whitelist-ip] [-spki-pin [sha256-pin]] [-group [group] ...] [-exclude-default-group]
#   -spki-pin: TLS spki pin to verify.
#   -tls-host-verify: cert hostname to verify.
#   -host-name: TLS sni hostname.
#   -http-host: http host.
#   -no-check-certificate: no check certificate.
#   -proxy [proxy-name]: use proxy to connect to server.
#   -bootstrap-dns: set as bootstrap dns server.
# default port is 443
# server-https https://cloudflare-dns.com/dns-query

# socks5 and http proxy list
# proxy-server URL -name [proxy name]
#   URL: socks5://[username:password@]host:port
#        http://[username:password@]host:port
#   -name: proxy name, use with server -proxy [proxy-name]
# example:
#   proxy-server socks5://user:pass@1.2.3.4:1080 -name proxy
#   proxy-server http://user:pass@1.2.3.4:3128 -name proxy

# specific nameserver to domain
# nameserver /domain/[group|-]
# nameserver /www.example.com/office, Set the domain name to use the appropriate server group.
# nameserver /www.example.com/-, ignore this domain

# specific address to domain
# address /domain/[ip|-|-4|-6|#|#4|#6]
# address /www.example.com/1.2.3.4, return ip 1.2.3.4 to client
# address /www.example.com/-, ignore address, query from upstream, suffix 4, for ipv4, 6 for ipv6, none for all
# address /www.example.com/#, return SOA to client, suffix 4, for ipv4, 6 for ipv6, none for all

# specific cname to domain
# cname /domain/target

# enalbe DNS64 feature
# dns64 [ip/subnet]
# dns64 64:ff9b::/96

# enable ipset timeout by ttl feature
# ipset-timeout [yes]

# specific ipset to domain
# ipset /domain/[ipset|-]
# ipset /www.example.com/block, set ipset with ipset name of block 
# ipset /www.example.com/-, ignore this domain

# add to ipset when ping is unreachable
# ipset-no-speed ipsetname
# ipset-no-speed pass

# enable nftset timeout by ttl feature
# nftset-timeout [yes|no]
# nftset-timeout yes

# add to nftset when ping is unreachable
# nftset-no-speed [#4:ip#table#set,#6:ipv6#table#setv6]
# nftset-no-speed #4:ip#table#set

# enable nftset debug, check nftset setting result, output log when error.
# nftset-debug [yes|no]
# nftset-debug yes

# specific nftset to domain
# nftset /domain/[#4:ip#table#set,#6:ipv6#table#setv6]
# nftset /www.example.com/ip#table#set, equivalent to 'nft add element ip table set { ... }'
# nftset /www.example.com/-, ignore this domain
# nftset /www.example.com/#6:-, ignore ipv6

# set domain rules
# domain-rules /domain/ [-speed-check-mode [...]]
# rules:
#   [-c] -speed-check-mode [mode]: speed check mode
#                             speed-check-mode [ping|tcp:port|none|,]
#   [-a] -address [address|-]: same as address option
#   [-n] -nameserver [group|-]: same as nameserver option
#   [-p] -ipset [ipset|-]: same as ipset option
#   [-t] -nftset [nftset|-]: same as nftset option
#   [-d] -dualstack-ip-selection [yes|no]: same as dualstack-ip-selection option
#   -no-serve-expired: ignore expired domain
#   -delete: delete domain rule

# collection of domains 
# the domain-set can be used with /domain/ for address, nameserver, ipset, etc.
# domain-set -name [set-name] -type list -file [/path/to/file]
#   [-n] -name [set name]: domain set name
#   [-t] -type [list]: domain set type, list only now
#   [-f] -file [path/to/set]: file path of domain set
# 
# example:
# domain-set -name domain-list -type list -file /etc/smartdns/domain-list.conf
# address /domain-set:domain-list/1.2.3.4
# nameserver /domain-set:domain-list/server-group
# ipset /domain-set:domain-list/ipset
# domain-rules /domain-set:domain-list/ -speed-check-mode ping
</code></pre>
<h3><a id="smartdns%E7%AE%A1%E7%90%86" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>SmartDNS 管理</h3>
<p>暂停mosdns：</p>
<pre class="line-numbers"><code class="language-plain_text">$ brew services stop mosdns
$ sudo /opt/local/etc/mosdns/mosdns service uninstall
</code></pre>
<p>启动SmartDNS：</p>
<pre class="line-numbers"><code class="language-plain_text">$ sudo brew services start smartdns
</code></pre>
<p>使用<code>sudo</code>命令会自动添加到开机启动项，启动配置文件位置：<code>/Library/LaunchDaemons/homebrew.mxcl.smartdns.plist</code>。</p>
<p>如果不需要后台服务，可以执行命令：</p>
<pre class="line-numbers"><code class="language-plain_text">$ sudo /opt/homebrew/opt/smartdns/sbin/smartdns run -c /opt/homebrew/etc/smartdns/smartdns.conf
</code></pre>
<p>检查SmartDNS是否正常启动：</p>
<pre class="line-numbers"><code class="language-plain_text">$ sudo lsof -Pni UDP:5304
</code></pre>
<p>重启与暂停SmartDNS：</p>
<pre class="line-numbers"><code class="language-plain_text">$ sudo brew services start/restart/stop smartdns
</code></pre>
<h2><a id="smartdns%E5%B1%8F%E8%94%BD%E5%B9%BF%E5%91%8A%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>SmartDNS 屏蔽广告（可选）</h2>
<p>由于SmartDNS也具有屏蔽广告的功能，可以不再需要AdGuardHome，仅需将AdGuardHome关闭，并将SmartDNS端口设置为53即可。</p>
<ol>
<li>下载配置文件到目录<code>/opt/homebrew/etc/smartdns/</code></li>
</ol>
<pre class="line-numbers"><code class="language-plain_text">$ wget https://anti-ad.net/anti-ad-for-smartdns.conf -O /opt/homebrew/etc/smartdns/anti-ad-smartdns.conf
</code></pre>
<ol start="2">
<li>修改<code>/opt/homebrew/etc/smartdns/smartdns.conf</code>文件，包含上述配置文件</li>
</ol>
<pre class="line-numbers"><code class="language-plain_text">conf-file /opt/homebrew/etc/smartdns/anti-ad-smartdns.conf
</code></pre>
<p>其他广告列表见<a href="https://pymumu.github.io/smartdns/config/ad-block/">SmartDNS广告过滤列表</a>，可以定期下载更新文件，并重启SmartDNS生效。</p>
<h2><a id="%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>参考资料</h2>
<ul>
<li>Dnsmasq-china-list<br />
<a href="https://github.com/felixonmars/dnsmasq-china-list">https://github.com/felixonmars/dnsmasq-china-list</a></li>
<li>SmartDNS <a href="https://github.com/mokeyish/smartdns-rs/">https://github.com/mokeyish/smartdns-rs</a></li>
<li>SmartDNS文档主页 <a href="https://pymumu.github.io/smartdns/">https://pymumu.github.io/smartdns/</a></li>
<li>SmartDNS分流加速 <a href="https://fordes.dev/posts/tutorials/dns-shunt/">https://fordes.dev/posts/tutorials/dns-shunt</a></li>
<li>超简易的方法实现SmartDNS分组 <a href="https://www.right.com.cn/forum/thread-4244241-1-1.html">https://www.right.com.cn/forum/thread-4244241-1-1.html</a></li>
</ul>

                  </article>
                  <div class="comments-wrap">
                    <div class="share-comments">
                      

                      

                      
                    </div>
                  </div><!-- end comments wrap -->
              </div>
            </div><!-- end columns -->
      </div><!-- end container -->
    </section>



    <footer class="footer">
        <div class="content has-text-centered">
          <p>
              Copyright &copy; 2024
              Powered by <a target="_blank" href="https://www.mweb.im">MWeb</a>,&nbsp; 
              Theme used <a target="_blank" href="https://bulma.io/">Bulma CSS</a>.
          </p>
        </div>
      </footer>



  













<script src="asset/prism.js"></script>



  
    




  </body>
</html>
